name: Debug

on:
  workflow_dispatch:
    inputs:
      code-ref:
        type: string
        default: "ci-debug/workflows"
        description: "Git ref (branch/tag/SHA) to test"
      parallel-tests:
        type: boolean
        default: true
        description: "Run tests in parallel"

concurrency:
  group: ${{ github.workflow }}-${{ inputs.code-ref }}
  cancel-in-progress: true

jobs:
  run_tests:
    name: Run core-tests on ${{ matrix.system.os }} with ${{ matrix.system.toolset }}, ${{ matrix.cfg.BUILD_TYPE }} ${{ matrix.cfg.SANITIZER }}
    continue-on-error: true
    strategy:
      matrix:
        system:
          - os: ubuntu-latest
            toolset: gcc
            env: CXX=g++-10

          - os: ubuntu-latest
            toolset: llvm-clang
            env: CXX=clang++-20 CXXFLAGS="-stdlib=libc++" LDFLAGS="-lc++abi"

        cfg:
          - { BUILD_TYPE: Debug, SANITIZER: ADDRESS }
          - { BUILD_TYPE: Debug, SANITIZER: UB }

    runs-on: ${{ matrix.system.os }}

    steps:
      - name: Checkout CI scripts (main)
        uses: actions/checkout@v4
        with:
          ref: main
          path: ci

      - name: Checkout code under test
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.code-ref }}
          path: src
          fetch-depth: 0

      - name: Debug refs
        shell: bash
        run: |
          echo "Workflow yaml ref (button branch): ${{ github.ref }}"
          echo "Code ref input: ${{ inputs.code-ref }}"
          echo "CI scripts (main) HEAD:"
          (cd ci && git log -1 --oneline)
          echo "Code under test HEAD:"
          (cd src && git log -1 --oneline)

      - name: Install dependencies
        uses: ./ci/.github/composite-actions/install-dependencies
        with:
          os: ${{ matrix.system.os }}
          toolset: ${{ matrix.system.toolset }}

      - name: Download datasets
        uses: ./ci/.github/composite-actions/download-datasets

      - name: Link datasets into src (if needed)
        shell: bash
        run: |
          if [[ -d "${GITHUB_WORKSPACE}/datasets" && ! -e "${GITHUB_WORKSPACE}/src/datasets" ]]; then
            ln -s "${GITHUB_WORKSPACE}/datasets" "${GITHUB_WORKSPACE}/src/datasets"
          fi

      - name: Build
        shell: bash
        working-directory: src
        run: |
          export ${{ matrix.system.env }}

          if [[ "${{ matrix.cfg.BUILD_TYPE }}" == "Debug" ]]; then
            SAN="${{ matrix.cfg.SANITIZER }}"
            if [[ -n "$SAN" ]]; then
              ./build.sh --debug --sanitizer="$SAN"
            else
              ./build.sh --debug
            fi
          else
            ./build.sh
          fi

      - name: Test
        working-directory: src/build
        shell: bash
        run: |
          export ${{ matrix.system.runtime-env }}

          if [[ "${{ inputs.parallel-tests }}" != "false" ]]; then
            if command -v nproc >/dev/null 2>&1; then
              CORES="$(nproc)"
            else
              CORES="$(sysctl -n hw.ncpu)"
            fi
            export CTEST_ARGS="-j ${CORES} --output-on-failure -V"
          fi

          ctest --exclude-regex ".*HeavyDatasets.*" $CTEST_ARGS
