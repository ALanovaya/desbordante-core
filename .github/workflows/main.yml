name: CIND ASan (Ubuntu only)

on:
  workflow_dispatch:
    inputs:
      parallel-tests:
        type: boolean
        default: true
        description: "Run tests in parallel"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  cind_asan:
    name: CIND tests on Ubuntu (${{ matrix.toolset }}) Debug + ASan
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - toolset: gcc
            env: CXX=g++
          - toolset: llvm-clang
            # Не хардкодим clang++-20: на ubuntu-latest его может не быть
            env: CXX=clang++

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        uses: ./.github/composite-actions/install-dependencies
        with:
          os: ubuntu-latest
          toolset: ${{ matrix.toolset }}

      - name: Download datasets
        uses: ./.github/composite-actions/download-datasets

      - name: Build (Debug + ASan)
        shell: bash
        run: |
          set -euxo pipefail
          export ${{ matrix.env }}
          $CXX --version
          ./build.sh --debug --sanitizer=ADDRESS

      - name: Configure ASan symbolization + options
        shell: bash
        run: |
          set -euxo pipefail

          echo "llvm-symbolizer: $(command -v llvm-symbolizer || true)"
          if command -v llvm-symbolizer >/dev/null 2>&1; then
            echo "ASAN_SYMBOLIZER_PATH=$(command -v llvm-symbolizer)" >> "$GITHUB_ENV"
          fi

          # Максимально полезный вывод ASan в CI
          echo "ASAN_OPTIONS=abort_on_error=1:halt_on_error=1:symbolize=1:print_stacktrace=1:detect_leaks=1:fast_unwind_on_malloc=0:detect_container_overflow=1" >> "$GITHUB_ENV"
          echo "LSAN_OPTIONS=verbosity=1" >> "$GITHUB_ENV"

          # Иногда локаль влияет на парсинг/сортировку
          echo "LC_ALL=C.UTF-8" >> "$GITHUB_ENV"
          echo "LANG=C.UTF-8" >> "$GITHUB_ENV"

      - name: Sanity-check that CTest sees tests
        shell: bash
        run: |
          set -euxo pipefail

          # Если вы случайно запускаете ctest не из того каталога — тут это сразу всплывёт
          test -f build/CTestTestfile.cmake

          echo "----- First lines of build/CTestTestfile.cmake -----"
          head -n 80 build/CTestTestfile.cmake || true

          echo "----- ctest -N (first 200 lines) -----"
          ctest --test-dir build -N | head -n 200

          # Гарантируем, что именно CIND-тесты зарегистрированы
          if ! ctest --test-dir build -N | grep -q "CINDTestSuite"; then
            echo "ERROR: CINDTestSuite tests are not registered in CTest (wrong build dir or tests not generated)."
            exit 1
          fi

      - name: Run only CIND tests (verbose + output-on-failure)
        shell: bash
        run: |
          set -euxo pipefail

          if [[ "${{ inputs.parallel-tests }}" != "false" ]]; then
            CTEST_ARGS="-j $(nproc)"
          else
            CTEST_ARGS=""
          fi

          # -VV и --output-on-failure нужны, чтобы увидеть *почему* упало (assert/asan/exception)
          ctest --test-dir build \
            -R "^CINDTestSuite/" \
            --output-on-failure -VV \
            $CTEST_ARGS

      - name: Fallback: run gtest binary directly (if ctest fails)
        if: failure()
        shell: bash
        run: |
          set -euxo pipefail
          if [[ -x build/target/Desbordante_test ]]; then
            build/target/Desbordante_test \
              --gtest_filter='CINDTestSuite/*' \
              --gtest_color=yes \
              --gtest_print_time=1
          fi
