name: Ubuntu CIND (Debug + ASan)

on:
  workflow_dispatch:
    inputs:
      ref:
        description: "Branch / tag / SHA to test (e.g. your PR branch)"
        required: true
        default: "main"

concurrency:
  group: ${{ github.workflow }}-${{ github.event.inputs.ref }}
  cancel-in-progress: true

jobs:
  run_cind_tests:
    name: CIND on Ubuntu (${{ matrix.system.toolset }})
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        system:
          - toolset: gcc
            env: CXX=g++-10

          # FIX: do not pin to clang++-20 (often absent on ubuntu-latest)
          - toolset: llvm-clang
            env: CXX=clang++ CXXFLAGS="-stdlib=libc++" LDFLAGS="-lc++abi"

    steps:
      - name: Checkout (ref=${{ inputs.ref }})
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}

      - name: Install dependencies (repo action)
        uses: ./.github/composite-actions/install-dependencies
        with:
          os: ubuntu-latest
          toolset: ${{ matrix.system.toolset }}

      # FIX: ensure clang + libc++ exist when using clang toolset
      - name: Ensure clang + libc++ are installed (Ubuntu)
        if: matrix.system.toolset == 'llvm-clang'
        shell: bash
        run: |
          set -euxo pipefail
          sudo apt-get update
          sudo apt-get install -y clang libc++-dev libc++abi-dev
          which clang++
          clang++ --version

      - name: Download datasets
        uses: ./.github/composite-actions/download-datasets

      - name: Build (Debug + ASan)
        shell: bash
        run: |
          set -euxo pipefail
          export ${{ matrix.system.env }}
          ./build.sh --debug --sanitizer=ADDRESS

      - name: Test (only CIND, verbose, single-thread)
        working-directory: ${{ github.workspace }}/build
        shell: bash
        run: |
          set -euxo pipefail

          # ASan symbolizer for good stack traces
          sudo apt-get update
          sudo apt-get install -y llvm
          export ASAN_SYMBOLIZER_PATH="$(which llvm-symbolizer)"

          export ASAN_OPTIONS="abort_on_error=1:symbolize=1:print_stacktrace=1:detect_container_overflow=1"
          export UBSAN_OPTIONS="print_stacktrace=1"

          ctest -R "CINDTestSuite" \
            --exclude-regex ".*HeavyDatasets.*" \
            -j1 -VV --output-on-failure

          echo "----- LastTest.log -----"
          cat Testing/Temporary/LastTest.log || true

      - name: Upload CTest logs (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ctest-logs-${{ matrix.system.toolset }}
          path: |
            build/Testing/Temporary/LastTest.log
            build/Testing/Temporary/LastTestsFailed.log
          if-no-files-found: ignore
